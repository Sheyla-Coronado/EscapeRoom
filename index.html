<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escape‚Ä¶ if you can!</title>
  <style>
    /* ========== VARIABLES ========== */
    :root {
      --bg: #1e1e2f;
      --panel: #2a2a40;
      --accent: #c9a227;
      --text: #f5f5f5;
    }

    /* ========== BASE STYLES ========== */
    * {
      box-sizing: border-box;
      font-family: system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: auto;
      padding: 16px;
    }

    h1, h2, h3 {
      margin-bottom: 12px;
    }

    /* ========== SCREEN NAVIGATION ========== */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* ========== BUTTONS ========== */
    button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #000;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
    }

    button.secondary {
      background: #444;
      color: #fff;
    }

    /* ========== FORM INPUTS ========== */
    select, input {
      padding: 6px;
      border-radius: 6px;
      border: none;
    }

    /* ========== CARD GRID ========== */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--panel);
      border-radius: 10px;
      padding: 12px;
    }

    /* ========== ROOMS SCREEN ========== */
    .rooms-topbar {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .rooms-header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .rooms-search {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      flex-wrap: nowrap;
    }

    .back-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 6px;
      font-size: 16px;
      background: #444;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-right: 8px;
      margin-top: 0;
      margin-bottom: 0;
    }

    .search-input {
      flex: 1;
      max-width: 260px;
      min-width: 0;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
    }

    .filter-anchor {
      position: relative;
      display: inline-block;
    }

    .filter-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      font-size: 20px;
      background: #444;
      color: #fff;
      padding: 0;
      margin: 0;
    }

    .filter-menu {
      position: absolute;
      top: 50%;
      left: calc(100% + 8px);
      transform: translateY(-50%);
      background: var(--panel);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 999;
      min-width: 160px;
    }

    /* ========== GAME SCREEN ========== */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .game {
      background: var(--panel);
      border-radius: 12px;
      padding: 12px;
    }

    .game-view {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 2;
      max-height: 66vh;
      border-radius: 10px;
      margin-bottom: 8px;
      background-color: #111;
      display: block;
      padding: 0;
      overflow: hidden;
    }

    .game-view img#sceneImage,
    .game-view svg#sceneImage {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center 30%;
      border-radius: 8px;
      z-index: 1;
    }

    /* ========== HOTSPOTS ========== */
    .hotspot {
      position: absolute;
      background: transparent;
      border: none;
      cursor: pointer;
      z-index: 50;
      pointer-events: auto;
      transition: none;
    }

    /* Mystery Mansion Hotspots */
    .room-mystery .hotspot.painting {
      left: 44.1667%;
      top: 6%;
      width: 13%;
      height: 25%;
    }

    .room-mystery .hotspot.fireplace {
      left: 40%;
      top: 33.75%;
      width: 20%;
      height: 27.5%;
    }

    .room-mystery .hotspot.door {
      left: 73%;
      top: 25%;
      width: 10%;
      height: 35%;
      z-index: 60;
    }

    .room-mystery .hotspot.safe {
      left: 73%;
      top: 70%;
      width: 5%;
      height: 10%;
      z-index: 60;
    }

    .room-mystery .hotspot.rug {
      left: 36.6667%;
      top: 70%;
      width: 26.6667%;
      height: 15%;
    }

    .room-mystery .hotspot.books {
      left: 20%;
      top: 53%;
      width: 6.6667%;
      height: 15%;
    }

/* Magical Library Hotspots */
.room-library .hotspot.crystal {
  left: 40%;
  top: 35%;
  width: 6%;
  height: 5%;
}

.room-library .hotspot.bookshelf {
  left: 8%;
  top: 5%;
  width: 5%;
  height: 5%;
}

.room-library .hotspot.candles {
  left: 48%;
  top: 28%;
  width: 8%;
  height: 13%;
}

.room-library .hotspot.scroll {
  left: 18%;
  top: 83%;
  width: 5%;
  height: 5%;
}

.room-library .hotspot.chest {
  left: 46%;
  top: 15%;
  width: 12%;
  height: 12%;
}

.room-library .hotspot.door {
  left: 63%;
  top: 8%;
  width: 18%;
  height: 45%;
  z-index: 60;
}

/* Pirate Cove Hotspots */
.room-pirate .hotspot.map {
  left: 4%;
  top: 48%;
  width: 8%;
  height: 10%;
}

.room-pirate .hotspot.barrel {
  left: 25%;
  top: 58%;
  width: 3%;
  height: 10%;
}

.room-pirate .hotspot.crates {
  left: 15%;
  top: 68%;
  width: 10%;
  height: 12%;
}

.room-pirate .hotspot.campfire {
  left: 45%;
  top: 55%;
  width: 5%;
  height: 8%;
}

.room-pirate .hotspot.sand {
  left: 70%;
  top: 60%;
  width: 5%;
  height: 5%;
}

.room-pirate .hotspot.door {
  left: 63%;
  top: 68%;
  width: 8%;
  height: 8%;
  z-index: 60;
}


    /* Haunted Asylum Hotspots */
    .room-asylum .hotspot.bed {
      position: absolute;
      left: 54%;
      top: 30%;
      width: 14%;
      height: 32%;
      transform: rotate(35deg);
    }

    .room-asylum .hotspot.tv {
      left: 35%;
      top: 59%;
      width: 12%;
      height: 18%;
    }

    .room-asylum .hotspot.paper {
      left: 36%;
      top: 53%;
      width: 5%;
      height: 4%;
    }

    .room-asylum .hotspot.firstaid {
      left: 28%;
      top: 5%;
      width: 8%;
      height: 30%;
    }

    .room-asylum .hotspot.pipe {
      left: 8%;
      top: 5%;
      width: 6%;
      height: 20%;
    }

    .room-asylum .hotspot.door {
      left: 83%;
      top: 8%;
      width: 15%;
      height: 50%;
      z-index: 60;
    }

    .hotspot.show-outline {
      border: 2px solid rgba(255, 0, 0, 0.6);
      background: rgba(255, 0, 0, 0.06);
    }

    .hotspot.editing {
      outline: 3px dashed rgba(255, 0, 0, 0.9);
    }

    /* ========== INVENTORY ========== */
    .inventory {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.14);
      border-radius: 8px;
      margin-top: 8px;
    }

    .inv-label {
      font-size: 0.85rem;
      color: #ddd;
      margin-right: 8px;
    }

    .inv-items {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .inv-item {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      background: #fff;
      color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }

    .inv-item.selected {
      outline: 3px solid rgba(201, 162, 39, 0.9);
    }

    .clue-badge {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      background: #fef6e3;
      color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      border: 1px solid rgba(201, 162, 39, 0.25);
    }

    /* ========== DOOR KEYPAD ========== */
    #codeDisplay {
      font-family: monospace, monospace;
      text-align: center;
      padding: 8px 10px;
      background: #fff;
      color: #111;
      border-radius: 8px;
      display: inline-block;
      min-width: 124px;
      font-weight: 700;
      margin: 8px 0;
      letter-spacing: 14px;
      font-size: 26px;
    }

    #digitButtons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 320px;
      margin: 6px auto 12px;
    }

    #digitButtons .digit {
      width: 44px;
      min-width: 44px;
      height: 44px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #ddd;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      box-sizing: border-box;
      margin: 0;
    }

    #digitButtons .digit.digit-found {
      background: #fff;
      color: #111;
      font-weight: 600;
      border: 1px solid #ddd;
    }

    #digitButtons .digit.digit-disabled {
      opacity: 0.28;
      cursor: not-allowed;
      transform: scale(0.95);
    }

    /* ========== MODALS & OVERLAYS ========== */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      pointer-events: auto;
    }

    .menu {
      background: var(--panel);
      border-radius: 12px;
      padding: 16px;
      width: 280px;
      pointer-events: auto;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      pointer-events: auto;
    }

    .modal-content {
      background: var(--panel);
      padding: 16px;
      border-radius: 10px;
      max-width: 320px;
      position: relative;
      pointer-events: auto;
    }

    .modal-content button {
      width: auto;
      padding: 8px 12px;
    }

    /* ========== GAME PAUSE LOCK ========== */
    #game.paused .game-view,
    #game.paused .inventory {
      pointer-events: none;
      opacity: 0.7;
    }

    #game.paused .topbar {
      pointer-events: auto;
    }
    
    #game.paused .topbar button {
      pointer-events: auto;
    }

    /* ========== UTILITY CLASSES ========== */
    .hidden {
      display: none !important;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 480px) {
      .game-view {
        aspect-ratio: 3 / 2;
        max-height: 40vh;
      }
    }

    /* ========== RESPONSIVE UPGRADE ========== */

/* Base fluid scaling */
html {
  font-size: clamp(14px, 1.5vw, 16px);
}

/* App container adapts */
.app {
  padding: clamp(10px, 2vw, 16px);
}

/* Buttons scale better */
button {
  font-size: clamp(0.85rem, 1.5vw, 1rem);
}

/* Game view scales safely */
.game-view {
  width: 100%;
  max-height: 70vh;
}

/* Inventory adapts */
.inventory {
  flex-wrap: wrap;
}

.inv-item,
.clue-badge {
  width: clamp(32px, 8vw, 48px);
  height: clamp(32px, 8vw, 48px);
  font-size: clamp(14px, 3vw, 20px);
}

/* Room title + timer scale */
#roomTitle {
  font-size: clamp(0.9rem, 2.2vw, 1.1rem);
}

#timer {
  font-size: clamp(0.8rem, 2vw, 1rem);
}

/* ========================= */
/* üì± SMALL PHONES */
@media (max-width: 480px) {
  .topbar {
    gap: 6px;
  }

  .rooms-search {
    flex-wrap: wrap;
    justify-content: center;
  }

  .search-input {
    max-width: 100%;
  }

  .filter-menu {
    left: 0;
    top: calc(100% + 8px);
    transform: none;
  }

  .game-view {
    max-height: 42vh;
  }

  .inventory {
    gap: 6px;
  }
}

/* ========================= */
/* üì≤ TABLETS */
@media (min-width: 481px) and (max-width: 900px) {
  .game-view {
    max-height: 55vh;
  }

  .search-input {
    max-width: 320px;
  }
}

/* ========================= */
/* üñ• LARGE DESKTOPS */
@media (min-width: 1200px) {
  .app {
    max-width: 1200px;
  }

  .game-view {
    max-height: 75vh;
  }
}

  </style>
</head>
<body>
<div class="app">

  <!-- ========== MAIN MENU ========== -->
  <section id="main" class="screen active">
    <h1 id="mainTitle">üîë Escape‚Ä¶ if you can!</h1>
    <button onclick="resumeGame()" id="btnCurrentRoom">‚ñ∂ Current Room</button>
    <button onclick="showScreen('rooms')" id="btnBrowseRooms">üåê Browse Rooms</button>
    <button onclick="showScreen('settings')" id="btnSettings">‚öô Settings</button>
  </section>

  <!-- ========== ROOMS BROWSER ========== -->
  <section id="rooms" class="screen">
    <div class="topbar rooms-topbar">
      <div class="rooms-header">
        <h2 id="roomsTitle">Escape Rooms</h2>
      </div>

      <div class="rooms-search">
        <button class="back-btn" onclick="showScreen('main')">‚Üê</button>

        <input
          id="search"
          class="search-input"
          placeholder="Search rooms"
          oninput="renderRooms()"
        />

        <div class="filter-anchor">
          <button class="filter-btn" onclick="toggleFilterMenu()">‚ãØ</button>

          <div id="filterMenu" class="filter-menu hidden">
            <select id="difficulty" onchange="renderRooms()">
              <option value="" id="optDifficulty">Difficulty</option>
              <option id="optEasy">Easy</option>
              <option id="optMedium">Medium</option>
              <option id="optHard">Hard</option>
            </select>

            <select id="status" onchange="renderRooms()">
              <option value="" id="optStatus">Status</option>
              <option value="new" id="optNew">Not Played</option>
              <option value="progress" id="optProgress">In Progress</option>
              <option value="done" id="optDone">Completed</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="roomGrid" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- ========== GAME ========== -->
  <section id="game" class="screen">
    <div class="topbar">
      <button class="secondary" onclick="pauseGame()" style="width:44px;height:44px;padding:0;font-size:20px;margin:0;">‚ò∞</button>
      <strong id="roomTitle">Mystery Mansion ‚Äî Foyer</strong>
      <span id="timer">05:00</span>
    </div>

    <div class="game">
      <div class="game-view room-mystery" id="gameView">
        <img id="sceneImage" src="foyer.jpg" alt="Foyer" />

        <!-- Mystery Mansion Hotspots -->
        <div id="hotspotsMysterv" class="hotspots-container">
          <button class="hotspot books" title="Inspect books" onclick="interact('spot1')"></button>
          <button class="hotspot painting" title="Inspect painting" onclick="interact('spot2')"></button>
          <button class="hotspot fireplace" title="Inspect fireplace" onclick="interact('spot3')"></button>
          <button class="hotspot rug" title="Lift rug" onclick="interact('spot4')"></button>
          <button class="hotspot safe" title="Inspect safe" onclick="interact('spot5')"></button>
          <button class="hotspot door" title="Try door" onclick="tryDoor()"></button>
        </div>

        <!-- Magical Library Hotspots -->
        <div id="hotspotsLibrary" class="hotspots-container hidden">
          <button class="hotspot crystal" title="Inspect crystal ball" onclick="interact('spot1')"></button>
          <button class="hotspot bookshelf" title="Search bookshelf" onclick="interact('spot2')"></button>
          <button class="hotspot candles" title="Examine candles" onclick="interact('spot3')"></button>
          <button class="hotspot scroll" title="Read scroll" onclick="interact('spot4')"></button>
          <button class="hotspot chest" title="Open chest" onclick="interact('spot5')"></button>
          <button class="hotspot door" title="Push bookshelf" onclick="tryDoor()"></button>
        </div>

<!-- Pirate Cove Hotspots -->
<div id="hotspotsPirate" class="hotspots-container hidden">
  <button class="hotspot map" title="Search through papers" onclick="interact('spot1')"></button>
  <button class="hotspot barrel" title="Search barrel" onclick="interact('spot2')"></button>
  <button class="hotspot crates" title="Check crates" onclick="interact('spot3')"></button>
  <button class="hotspot campfire" title="Search around campfire" onclick="interact('spot4')"></button>
  <button class="hotspot sand" title="Check driftwood" onclick="interact('spot5')"></button>
  <button class="hotspot door" title="Dig for buried treasure" onclick="interact('spot6')"></button>
</div>

        <!-- Haunted Asylum Hotspots -->
        <div id="hotspotsAsylum" class="hotspots-container hidden">
          <button class="hotspot bed" title="Search bed" onclick="interact('spot1')"></button>
          <button class="hotspot tv" title="Examine TV" onclick="interact('spot2')"></button>
          <button class="hotspot paper" title="Read paper on TV" onclick="interact('spot3')"></button>
          <button class="hotspot firstaid" title="Open first-aid box" onclick="interact('spot4')"></button>
          <button class="hotspot pipe" title="Inspect pipe" onclick="interact('spot5')"></button>
          <button class="hotspot door" title="Try door" onclick="tryDoor()"></button>
        </div>
      </div>

      <div class="inventory" id="inventory">
        <div class="inv-label" id="invLabel">Inventory</div>
        <div class="inv-items" id="invItems"></div>
      </div>
    </div>
  </section>

  <!-- ========== VICTORY ========== -->
  <section id="victory" class="screen">
    <h1 id="victoryTitle">üéâ You Escaped!</h1>
    <p id="victoryText">You successfully completed the room!</p>
    <button onclick="showScreen('rooms')" id="btnBackToRooms">Back to Rooms</button>
    <button onclick="showScreen('main')" id="btnMainMenu">Main Menu</button>
  </section>

  <!-- ========== SETTINGS ========== -->
  <section id="settings" class="screen">
    <h2 id="settingsTitle">Settings</h2>
    <button onclick="toggleAudio()"><span id="btnAudioIcon">üîä</span> <span id="btnAudioText">Audio</span>: <span id="audioStatus">On</span></button>
    <button onclick="changeLanguage()">üåê <span id="btnLanguageText">Language</span>: <span id="langStatus">English</span></button>
    <button onclick="showControls()"><span id="btnControlsIcon">üéÆ</span> <span id="btnControlsText">Controls</span></button>
    <button onclick="showHowToPlay()"><span id="btnHelpIcon">‚ùì</span> <span id="btnHelpText">How to Play</span></button>
    <button onclick="showScreen('main')" id="btnClose">Close</button>
  </section>
</div>

<!-- ========== PAUSE MENU OVERLAY ========== -->
<div id="menuOverlay" class="menu-overlay">
  <div class="menu">
    <h3 id="pauseTitle">Paused</h3>
    <button onclick="resumeGame()" id="btnResume">Resume</button>
    <button onclick="showScreen('settings'); closeMenu()" id="btnPauseSettings">Settings</button>
    <button onclick="showScreen('main'); closeMenu()" id="btnQuit">Quit</button>
  </div>
</div>

<!-- ========== DOOR KEYPAD MODAL ========== -->
<div id="doorModal" class="modal hidden">
  <div class="modal-content">
    <h3 id="doorModalTitle">Door Keypad</h3>
    <p id="doorModalText">Enter the code by clicking the digits you have found</p>
    <div id="codeDisplay">_ _ _</div>
    <div id="digitButtons"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button onclick="submitDoorCode()" id="btnSubmit">Submit</button>
      <button onclick="clearDoorCode()" id="btnClear">Clear</button>
      <button onclick="closeDoorModal()" id="btnCloseDoor">Close</button>
    </div>
  </div>
</div>

<!-- ========== MESSAGE MODAL ========== -->
<div id="modal" class="modal">
  <div class="modal-content">
    <p id="modalText"></p>
    <button onclick="closeModal()" id="btnOK">OK</button>
  </div>
</div>

<!-- Menu / Lobby Music -->
<audio id="menuMusic" loop>
  <source src="mixkit-xanthos-633.mp3" type="audio/mpeg">
</audio>

<!-- In-Room Music -->
<audio id="roomMusic" loop>
  <source src="halloween-spooky-eerie-music-416618.mp3" type="audio/mpeg">
</audio>
<script>

  // ========== LANGUAGE SYSTEM ==========
  let currentLanguage = 'en';
  
  const translations = {
    en: {
      // Main Menu
      mainTitle: 'üîë Escape‚Ä¶ if you can!',
      btnCurrentRoom: '‚ñ∂ Current Room',
      btnBrowseRooms: 'üåê Browse Rooms',
      btnSettings: '‚öô Settings',
      
      // Rooms Browser
      roomsTitle: 'Escape Rooms',
      searchPlaceholder: 'Search rooms',
      optDifficulty: 'Difficulty',
      optEasy: 'Easy',
      optMedium: 'Medium',
      optHard: 'Hard',
      optStatus: 'Status',
      optNew: 'Not Played',
      optProgress: 'In Progress',
      optDone: 'Completed',
      btnEnter: 'Enter',
      
      // Victory
      victoryTitle: 'üéâ You Escaped!',
      victoryText: 'You successfully completed the room!',
      btnBackToRooms: 'Back to Rooms',
      btnMainMenu: 'Main Menu',
      
      // Settings
      settingsTitle: 'Settings',
      btnAudioText: 'Audio',
      btnLanguageText: 'Language',
      btnControlsText: 'Controls',
      btnHelpText: 'How to Play',
      btnClose: 'Close',
      audioOn: 'On',
      audioOff: 'Off',
      langEnglish: 'English',
      langSpanish: 'Spanish',
      
      // Pause Menu
      pauseTitle: 'Paused',
      btnResume: 'Resume',
      btnPauseSettings: 'Settings',
      btnQuit: 'Quit',
      
      // Door Modal
      doorModalTitle: 'Door Keypad',
      doorModalText: 'Enter the code by clicking the digits you have found',
      btnSubmit: 'Submit',
      btnClear: 'Clear',
      btnCloseDoor: 'Close',
      
      // General
      btnOK: 'OK',
      invLabel: 'Inventory',
      
      // Room names
      roomMysteryMansion: 'Mystery Mansion',
      roomMagicalLibrary: 'Magical Library',
      roomPirateCove: 'Pirate Cove',
      roomHauntedAsylum: 'Haunted Asylum',
      
      // Messages
      msgAlreadyFound: 'You already found this clue.',
      msgNothingElse: 'Nothing else remains here.',
      msgItemFound: 'You found a useful item!',
      msgNeedNumbers: 'You need to find some numbers first!',
      msgDoorUnlocked: 'The door is already unlocked.',
      msgIncorrectCode: 'Incorrect code. Keep looking for clues!',
      msgCodeIs3Digits: 'Code is 3 digits. Clear to re-enter.',
      msgControls: 'Click on hotspots to interact with them. Find clues hidden around the room to unlock the door.',
      msgHowToPlay: 'Find three number clues hidden around the room. Use them to unlock the door keypad and escape! Search different objects and locations.',
      msgHotspotSaved: 'Hotspot positions saved.',
      msgSelectHotspot: 'Select a hotspot first'
    },
    es: {
      // Main Menu
      mainTitle: 'üîë ¬°Escapa‚Ä¶ si puedes!',
      btnCurrentRoom: '‚ñ∂ Sala Actual',
      btnBrowseRooms: 'üåê Explorar Salas',
      btnSettings: '‚öô Configuraci√≥n',
      
      // Rooms Browser
      roomsTitle: 'Salas de Escape',
      searchPlaceholder: 'Buscar salas',
      optDifficulty: 'Dificultad',
      optEasy: 'F√°cil',
      optMedium: 'Medio',
      optHard: 'Dif√≠cil',
      optStatus: 'Estado',
      optNew: 'No Jugado',
      optProgress: 'En Progreso',
      optDone: 'Completado',
      btnEnter: 'Entrar',
      
      // Victory
      victoryTitle: 'üéâ ¬°Has Escapado!',
      victoryText: '¬°Has completado la sala exitosamente!',
      btnBackToRooms: 'Volver a Salas',
      btnMainMenu: 'Men√∫ Principal',
      
      // Settings
      settingsTitle: 'Configuraci√≥n',
      btnAudioText: 'Audio',
      btnLanguageText: 'Idioma',
      btnControlsText: 'Controles',
      btnHelpText: 'C√≥mo Jugar',
      btnClose: 'Cerrar',
      audioOn: 'Activado',
      audioOff: 'Desactivado',
      langEnglish: 'Ingl√©s',
      langSpanish: 'Espa√±ol',
      
      // Pause Menu
      pauseTitle: 'Pausado',
      btnResume: 'Reanudar',
      btnPauseSettings: 'Configuraci√≥n',
      btnQuit: 'Salir',
      
      // Door Modal
      doorModalTitle: 'Teclado de Puerta',
      doorModalText: 'Ingresa el c√≥digo haciendo clic en los d√≠gitos que encontraste',
      btnSubmit: 'Enviar',
      btnClear: 'Borrar',
      btnCloseDoor: 'Cerrar',
      
      // General
      btnOK: 'OK',
      invLabel: 'Inventario',
      
      // Room names
      roomMysteryMansion: 'Mansi√≥n Misteriosa',
      roomMagicalLibrary: 'Biblioteca M√°gica',
      roomPirateCove: 'Cala de Piratas',
      roomHauntedAsylum: 'Asilo Embrujado',
      
      // Messages
      msgAlreadyFound: 'Ya encontraste esta pista.',
      msgNothingElse: 'No queda nada m√°s aqu√≠.',
      msgItemFound: '¬°Encontraste un objeto √∫til!',
      msgNeedNumbers: '¬°Necesitas encontrar algunos n√∫meros primero!',
      msgDoorUnlocked: 'La puerta ya est√° desbloqueada.',
      msgIncorrectCode: '¬°C√≥digo incorrecto! Sigue buscando pistas.',
      msgCodeIs3Digits: 'El c√≥digo tiene 3 d√≠gitos. Borra para volver a ingresar.',
      msgControls: 'Haz clic en los puntos de inter√©s para interactuar con ellos. Encuentra pistas escondidas en la sala para desbloquear la puerta.',
      msgHowToPlay: '¬°Encuentra tres pistas num√©ricas escondidas en la sala. √ösalas para desbloquear el teclado de la puerta y escapar! Busca en diferentes objetos y ubicaciones.',
      msgHotspotSaved: 'Posiciones de puntos guardadas.',
      msgSelectHotspot: 'Selecciona un punto primero'
    }
  };

  function updateLanguage() {
    const lang = translations[currentLanguage];
    
    // Main Menu
    document.getElementById('mainTitle').textContent = lang.mainTitle;
    document.getElementById('btnCurrentRoom').textContent = lang.btnCurrentRoom;
    document.getElementById('btnBrowseRooms').textContent = lang.btnBrowseRooms;
    document.getElementById('btnSettings').textContent = lang.btnSettings;
    
    // Rooms Browser
    document.getElementById('roomsTitle').textContent = lang.roomsTitle;
    document.getElementById('search').placeholder = lang.searchPlaceholder;
    document.getElementById('optDifficulty').textContent = lang.optDifficulty;
    document.getElementById('optEasy').textContent = lang.optEasy;
    document.getElementById('optMedium').textContent = lang.optMedium;
    document.getElementById('optHard').textContent = lang.optHard;
    document.getElementById('optStatus').textContent = lang.optStatus;
    document.getElementById('optNew').textContent = lang.optNew;
    document.getElementById('optProgress').textContent = lang.optProgress;
    document.getElementById('optDone').textContent = lang.optDone;
    
    // Victory
    document.getElementById('victoryTitle').textContent = lang.victoryTitle;
    document.getElementById('victoryText').textContent = lang.victoryText;
    document.getElementById('btnBackToRooms').textContent = lang.btnBackToRooms;
    document.getElementById('btnMainMenu').textContent = lang.btnMainMenu;
    
    // Settings
    document.getElementById('settingsTitle').textContent = lang.settingsTitle;
    document.getElementById('btnAudioText').textContent = lang.btnAudioText;
    document.getElementById('btnLanguageText').textContent = lang.btnLanguageText;
    document.getElementById('btnControlsText').textContent = lang.btnControlsText;
    document.getElementById('btnHelpText').textContent = lang.btnHelpText;
    document.getElementById('btnClose').textContent = lang.btnClose;
    
    // Pause Menu
    document.getElementById('pauseTitle').textContent = lang.pauseTitle;
    document.getElementById('btnResume').textContent = lang.btnResume;
    document.getElementById('btnPauseSettings').textContent = lang.btnPauseSettings;
    document.getElementById('btnQuit').textContent = lang.btnQuit;
    
    // Door Modal
    document.getElementById('doorModalTitle').textContent = lang.doorModalTitle;
    document.getElementById('doorModalText').textContent = lang.doorModalText;
    document.getElementById('btnSubmit').textContent = lang.btnSubmit;
    document.getElementById('btnClear').textContent = lang.btnClear;
    document.getElementById('btnCloseDoor').textContent = lang.btnCloseDoor;
    
    // General
    document.getElementById('btnOK').textContent = lang.btnOK;
    document.getElementById('invLabel').textContent = lang.invLabel;
    
    // Update language status
    document.getElementById('langStatus').textContent = currentLanguage === 'en' ? lang.langEnglish : lang.langSpanish;
    
    // Re-render rooms to update room names
    renderRooms();
    
    // Update room title if in game
    const roomData = roomsData[currentRoom];
    if (roomData) {
      document.getElementById('roomTitle').textContent = currentLanguage === 'en' ? roomData.titleEN : roomData.titleES;
    }
  }

  function changeLanguage() {
    currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
    updateLanguage();
  }

 // ========== AUDIO SYSTEM ==========
  let audioEnabled = true;
  const menuMusic = document.getElementById("menuMusic");
  const roomMusic = document.getElementById("roomMusic");

  function toggleAudio() {
    audioEnabled = !audioEnabled;
    const lang = translations[currentLanguage];
    document.getElementById('audioStatus').textContent =
      audioEnabled ? lang.audioOn : lang.audioOff;
    if (audioEnabled) playMenuMusic();
    else { menuMusic.pause(); roomMusic.pause(); }
  }

  function playMenuMusic() {
    if (!audioEnabled) return;
    roomMusic.pause();
    roomMusic.currentTime = 0;
    menuMusic.volume = 0.25;
    if (menuMusic.paused) menuMusic.play().catch(()=>{});
  }

  function playRoomMusic() {
    if (!audioEnabled) return;
    menuMusic.pause();
    menuMusic.currentTime = 0;
    roomMusic.volume = 0.4;
    if (roomMusic.paused) roomMusic.play().catch(()=>{});
  }

  // Autoplay menu music on page load
  window.addEventListener('DOMContentLoaded', () => {
    playMenuMusic();
  });

  // ========== DATA & STATE ==========
  const roomsData = {
    'Mystery Mansion': {
      titleEN: 'Mystery Mansion ‚Äî Foyer',
      titleES: 'Mansi√≥n Misteriosa ‚Äî Vest√≠bulo',
      className: 'room-mystery',
      hotspotsId: 'hotspotsMysterv',
      image: 'foyer.jpg', 
      time: 300,
      code: '042',
      clues: {
        spot1: { 
          number: 2, 
          found: false, 
          messageEN: 'You found a number hidden inside an old book!',
          messageES: '¬°Encontraste un n√∫mero escondido dentro de un libro viejo!'
        },
        spot2: { 
          number: 0, 
          found: false, 
          messageEN: 'Behind the painting, a number is scratched into the wall!',
          messageES: '¬°Detr√°s de la pintura, un n√∫mero est√° grabado en la pared!'
        },
        spot3: { 
          item: 'üß©', 
          found: false, 
          messageEN: 'You find a metal code plate in the fireplace ashes! Looks like it might be useful',
          messageES: '¬°Encuentras una placa de c√≥digo met√°lica en las cenizas de la chimenea! Parece que pueda ser importante'
        },
        spot4: { 
          number: 4, 
          found: false, 
          messageEN: 'Under the rug, you discover a number carved into the floor!',
          messageES: '¬°Bajo la alfombra, descubres un n√∫mero tallado en el suelo!'
        },
        spot5: { 
          item: 'üîê', 
          found: false, 
          messageEN: 'The safe opens! Inside is a brass bolt.',
          messageES: '¬°La caja fuerte se abre! Dentro hay un perno de lat√≥n.'
        }
      }
    },
    'Magical Library': {
      titleEN: 'Magical Library ‚Äî Reading Room',
      titleES: 'Biblioteca M√°gica ‚Äî Sala de Lectura',
      className: 'room-library',
      hotspotsId: 'hotspotsLibrary',
      image: 'library.png',
      time: 240,
      code: 'none',
      requiresItems: ['üîÆ', 'üïØÔ∏è', 'üìú'],
      clues: {
        spot1: { 
          item: 'üîÆ', 
          found: false, 
          messageEN: 'The crystal ball pulses with magical energy! It might unlock something...',
          messageES: '¬°La bola de cristal pulsa con energ√≠a m√°gica! Podr√≠a desbloquear algo...'
        },
        spot2: { 
          item: 'üìö', 
          found: false, 
          messageEN: 'You find an ancient tome about secret passages in magical libraries!',
          messageES: '¬°Encuentras un tomo antiguo sobre pasajes secretos en bibliotecas m√°gicas!'
        },
        spot3: { 
          item: 'üïØÔ∏è', 
          found: false, 
          messageEN: 'An enchanted candle! Its flame reveals hidden truths.',
          messageES: '¬°Una vela encantada! Su llama revela verdades ocultas.'
        },
        spot4: { 
          item: 'üìú', 
          found: false, 
          messageEN: 'A mystical scroll with strange symbols that seem to point toward the bookshelf...',
          messageES: 'Un pergamino m√≠stico con s√≠mbolos extra√±os que parecen apuntar hacia la estanter√≠a...'
        },
        spot5: { 
          item: '‚ú®', 
          found: false, 
          messageEN: 'A vial of stardust! Pure magical essence.',
          messageES: '¬°Un frasco de polvo de estrellas! Esencia m√°gica pura.'
        }
      }
    },
'Pirate Cove': {
  titleEN: 'Pirate Cove ‚Äî Captain\'s Quarters',
  titleES: 'Cala de Piratas ‚Äî Camarote del Capit√°n',
  className: 'room-pirate',
  hotspotsId: 'hotspotsPirate',
  image: 'pirate.jpg',
  time: 360,
  code: 'treasure',
  requiresItems: ['üó∫Ô∏è', '‚öì', 'üß≠', 'üóùÔ∏è'],
  clues: {
    spot1: { 
      item: 'üó∫Ô∏è', 
      found: false, 
      messageEN: 'An old treasure map showing an X marked on the beach!',
      messageES: '¬°Un viejo mapa del tesoro mostrando una X marcada en la playa!'
    },
    spot2: { 
      item: 'üç∫', 
      found: false, 
      messageEN: 'A bottle of ancient rum hidden in the barrel!',
      messageES: '¬°Una botella de ron antiguo escondida en el barril!'
    },
    spot3: { 
      item: 'üß≠', 
      found: false, 
      messageEN: 'A compass hidden in a crate! It points toward the beach.',
      messageES: '¬°Una br√∫jula escondida en una caja! Apunta hacia la playa.'
    },
    spot4: { 
      item: '‚öì', 
      found: false, 
      messageEN: 'A golden anchor medallion buried in the sand near the fire!',
      messageES: '¬°Un medall√≥n de ancla dorado enterrado en la arena cerca del fuego!'
    },
    spot5: { 
      item: 'üóùÔ∏è', 
      found: false, 
      messageEN: 'A rusty key hidden beneath some driftwood! This must unlock the treasure.',
      messageES: '¬°Una llave oxidada escondida bajo madera flotante! Esto debe abrir el tesoro.'
    },
    spot6: {
      treasure: true,
      found: false,
      messageEN: 'The buried treasure location...',
      messageES: 'La ubicaci√≥n del tesoro enterrado...'
    }
  }
},
'Haunted Asylum': {
  titleEN: 'Haunted Asylum ‚Äî Abandoned Ward',
  titleES: 'Asilo Embrujado ‚Äî Pabell√≥n Abandonado',
  className: 'room-asylum',
  hotspotsId: 'hotspotsAsylum',
  image: 'asylum.jpg',
  time: 420,
  code: '138',
  clues: {
    spot1: { 
      number: 1, 
      found: false, 
      messageEN: 'Under the stained mattress, you find a patient record with the number 1 circled in red ink...',
      messageES: 'Bajo el colch√≥n manchado, encuentras un registro de paciente con el n√∫mero 1 circulado en tinta roja...'
    },
    spot2: { 
      item: 'üì∫', 
      found: false, 
      messageEN: 'The old TV flickers to life briefly, showing static and a strange symbol...',
      messageES: 'El viejo televisor parpadea brevemente, mostrando est√°tica y un s√≠mbolo extra√±o...'
    },
    spot3: { 
      number: 3, 
      found: false, 
      messageEN: 'The paper on top of the TV has patient notes... the number 3 is written repeatedly.',
      messageES: 'El papel encima del televisor tiene notas de paciente... el n√∫mero 3 est√° escrito repetidamente.'
    },
    spot4: { 
      item: 'üíä', 
      found: false, 
      messageEN: 'The first-aid box contains old medicine bottles and syringes. One bottle glows faintly...',
      messageES: 'El botiqu√≠n contiene viejos frascos de medicina y jeringas. Un frasco brilla d√©bilmente...'
    },
    spot5: { 
      number: 8, 
      found: false, 
      messageEN: 'Behind the rusty pipe, you find scratched marks counting to 8...',
      messageES: 'Detr√°s del tubo oxidado, encuentras marcas rayadas contando hasta 8...'
    }
  }
}
};

  const rooms = [
    { name: 'Mystery Mansion', difficulty: 'Medium', status: 'progress' },
    { name: 'Magical Library', difficulty: 'Easy', status: 'done' },
    { name: 'Pirate Cove', difficulty: 'Medium', status: 'new' },
    { name: 'Haunted Asylum', difficulty: 'Hard', status: 'new' }
  ];

  let time = 300;
  let interval = null;
  let paused = true;
  let currentRoom = 'Mystery Mansion';

  const state = {
    inventory: [],
    foundDigits: [],
    selectedItem: null
  };

  let DOOR_CODE = '042';
  let clues = roomsData['Mystery Mansion'].clues;

  
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  // Handle music based on screen
  if (id === 'main' || id === 'rooms' || id === 'settings' || id === 'victory') {
    playMenuMusic();
  } else if (id === 'game') {
    playRoomMusic();
  }

}

// Call this whenever you actually enter a room
function enterRoom(roomName, roomTime) {
  currentRoom = roomName;
  time = roomTime;
  paused = false;

  showScreen('game');
  startTimer();
  playRoomMusic();
}

// Call this whenever you leave a room back to menu/screens
function leaveRoom() {
  stopTimer();
  paused = true;
  showScreen('main');
  playMenuMusic();
}

function pauseGame() {
  paused = true;
  stopTimer();

  document.getElementById('game').classList.add('paused');
  document.getElementById('menuOverlay').style.display = 'flex';
}

function resumeGame() {
  if (!currentRoom) {
    // If no current room, load the default room (Mystery Mansion)
    loadRoom('Mystery Mansion');
    return;
  }

  closeMenu();
  document.getElementById('game').classList.remove('paused');
  showScreen('game');

  if (paused) {
    paused = false;
    startTimer();
  }

  playRoomMusic();
}

function closeMenu() {
  document.getElementById('menuOverlay').style.display = 'none';
}

// Timer helpers
function startTimer() {
  clearInterval(interval);
  interval = setInterval(() => {
    if (time <= 0) {
      clearInterval(interval);
      alert("Time's up!");
      leaveRoom();
      return;
    }
    time--;
    const m = String(Math.floor(time / 60)).padStart(2, '0');
    const s = String(time % 60).padStart(2, '0');
    document.getElementById('timer').textContent = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  clearInterval(interval);
}

  // ========== ROOMS LIST ==========
  function renderRooms() {
    const grid = document.getElementById('roomGrid');
    grid.innerHTML = '';
    const s = document.getElementById('search').value.toLowerCase();
    const d = document.getElementById('difficulty').value;
    const st = document.getElementById('status').value;
    const lang = translations[currentLanguage];

    rooms
      .filter(r =>
        (!s || r.name.toLowerCase().includes(s)) &&
        (!d || r.difficulty === d) &&
        (!st || r.status === st)
      )
      .forEach(r => {
        const c = document.createElement('div');
        c.className = 'card';
        
        // Get translated room name
        let roomName = r.name;
        if (currentLanguage === 'es') {
          const roomKey = 'room' + r.name.replace(/\s+/g, '');
          roomName = lang[roomKey] || r.name;
        }
        
        // Get translated difficulty
        let difficultyText = r.difficulty;
        if (currentLanguage === 'es') {
          if (r.difficulty === 'Easy') difficultyText = lang.optEasy;
          else if (r.difficulty === 'Medium') difficultyText = lang.optMedium;
          else if (r.difficulty === 'Hard') difficultyText = lang.optHard;
        }
        
        // Get translated status
        let statusText = r.status;
        if (currentLanguage === 'es') {
          if (r.status === 'new') statusText = lang.optNew;
          else if (r.status === 'progress') statusText = lang.optProgress;
          else if (r.status === 'done') statusText = lang.optDone;
        }
        
        const difficultyLabel = currentLanguage === 'es' ? 'Dificultad' : 'Difficulty';
        const statusLabel = currentLanguage === 'es' ? 'Estado' : 'Status';
        
        c.innerHTML = `<strong>${roomName}</strong><br>${difficultyLabel}: ${difficultyText}<br>${statusLabel}: ${statusText}`;
        const b = document.createElement('button');
        b.textContent = lang.btnEnter;
        b.onclick = () => {
          loadRoom(r.name);
        };
        c.appendChild(b);
        grid.appendChild(c);
      });
  }

  // ========== ROOM LOADING ==========
function loadRoom(roomName) {
  currentRoom = roomName;
  const roomData = roomsData[roomName];

  const sceneImage = document.getElementById('sceneImage');
  sceneImage.src = roomData.image;
  sceneImage.alt = roomName;
  
  time = roomData.time;
  DOOR_CODE = roomData.code;
  clues = roomData.clues;
  paused = false;
  
  // Set room title based on language
  const roomTitle = currentLanguage === 'en' ? roomData.titleEN : roomData.titleES;
  document.getElementById('roomTitle').textContent = roomTitle;
  
  // Update timer display
  const m = String(Math.floor(time / 60)).padStart(2, '0');
  const s = String(time % 60).padStart(2, '0');
  document.getElementById('timer').textContent = `${m}:${s}`;
  
  // Change room class for different hotspot layouts
  const gameView = document.getElementById('gameView');
  gameView.className = 'game-view ' + roomData.className;
  

  
  // Show/hide appropriate hotspot containers
  document.querySelectorAll('.hotspots-container').forEach(container => {
    container.classList.add('hidden');
  });
  document.getElementById(roomData.hotspotsId).classList.remove('hidden');
  
  // Reset state for new room
  state.inventory = [];
  state.foundDigits = [];
  state.selectedItem = null;
  doorUnlocked = false;
  doorEntry = '';
  
  // Reset all clues
  Object.keys(clues).forEach(key => {
    clues[key].found = false;
  });
  
  updateInventory();
  showScreen('game');
  startTimer();
  playRoomMusic();
}

  // ========== INVENTORY ==========
  function updateInventory() {
    const inv = document.getElementById('invItems');
    inv.innerHTML = '';

    // Add items
    state.inventory.forEach(item => {
      const el = document.createElement('div');
      el.className = 'inv-item';
      el.textContent = item;
      el.title = item;
      el.onclick = () => {
        state.selectedItem = state.selectedItem === item ? null : item;
        document.querySelectorAll('.inv-item').forEach(i => i.classList.remove('selected'));
        if (state.selectedItem) {
          el.classList.add('selected');
        }
      };
      inv.appendChild(el);
    });

    // Add found digits as clue badges
    state.foundDigits.forEach(d => {
      const dEl = document.createElement('div');
      dEl.className = 'inv-item clue-badge';
      dEl.textContent = d;
      dEl.title = (currentLanguage === 'es' ? 'Pista: ' : 'Clue: ') + d;
      inv.appendChild(dEl);
    });
  }

  // ========== MODALS ==========
  function showModal(text) {
    document.getElementById('modalText').textContent = text;
    document.getElementById('modal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  // ========== PUZZLE INTERACTIONS ==========
function interact(spotKey) {
  const clue = clues[spotKey];
  if (!clue) return;
  const lang = translations[currentLanguage];

  if (clue.found) {
    showModal(lang.msgNothingElse);
    return;
  }

  // Special case: Pirate treasure requires all items
  if (spotKey === 'spot6' && currentRoom === 'Pirate Cove') {
    const required = ['üó∫Ô∏è', '‚öì', 'üß≠', 'üóùÔ∏è'];
    const hasAll = required.every(item => state.inventory.includes(item));
    
    if (!hasAll) {
      const missing = [];
      if (!state.inventory.includes('üó∫Ô∏è')) missing.push(currentLanguage === 'en' ? 'map' : 'mapa');
      if (!state.inventory.includes('‚öì')) missing.push(currentLanguage === 'en' ? 'anchor medallion' : 'medall√≥n de ancla');
      if (!state.inventory.includes('üß≠')) missing.push(currentLanguage === 'en' ? 'compass' : 'br√∫jula');
      if (!state.inventory.includes('üóùÔ∏è')) missing.push(currentLanguage === 'en' ? 'key' : 'llave');
      
      const message = currentLanguage === 'en'
        ? `You need to find all the items before you can dig up the treasure! Still missing: ${missing.join(', ')}`
        : `¬°Necesitas encontrar todos los objetos antes de poder desenterrar el tesoro! A√∫n faltan: ${missing.join(', ')}`;
      showModal(message);
      return;
    }
    
    // Has all items - Open treasure and WIN!
    clue.found = true;
    doorUnlocked = true;
    const winMsg = currentLanguage === 'en'
      ? 'üè¥‚Äç‚ò†Ô∏è You dig up the buried treasure chest and unlock it with the key! Gold, jewels, and ancient artifacts spill out. You\'ve found the legendary pirate treasure!'
      : 'üè¥‚Äç‚ò†Ô∏è ¬°Desentierras el cofre del tesoro y lo abres con la llave! Oro, joyas y artefactos antiguos se derraman. ¬°Has encontrado el legendario tesoro pirata!';
    showModal(winMsg);
    setTimeout(() => showScreen('victory'), 2000);
    return;
  }

  // Special case: Safe requires puzzle piece to open (Mystery Mansion)
  if (spotKey === 'spot5' && currentRoom === 'Mystery Mansion') {
    if (!state.inventory.includes('üß©')) {
      const message = currentLanguage === 'en' 
        ? 'The safe is locked. You need something to open it...' 
        : 'La caja fuerte est√° cerrada. Necesitas algo para abrirla...';
      showModal(message);
      return;
    } else {
      // Remove puzzle piece from inventory when using it
      const index = state.inventory.indexOf('üß©');
      if (index > -1) {
        state.inventory.splice(index, 1);
        state.selectedItem = null;
      }
    }
  }

  clue.found = true;

  if (clue.number !== undefined) {
    state.foundDigits.push(String(clue.number));
    updateInventory();
    const message = currentLanguage === 'en' ? clue.messageEN : clue.messageES;
    showModal(message);
  } else if (clue.item) {
    state.inventory.push(clue.item);
    updateInventory();
    const message = currentLanguage === 'en' ? clue.messageEN : clue.messageES;
    showModal(message);
  }
}

  // ========== DOOR KEYPAD ==========
  let doorEntry = '';
  let doorUnlocked = false;

function tryDoor() {
  const lang = translations[currentLanguage];
  const roomData = roomsData[currentRoom];
  
  // Pirate Cove - Find treasure chest
  if (currentRoom === 'Pirate Cove') {
    const required = ['üó∫Ô∏è', '‚öì', 'üß≠', 'üóùÔ∏è'];
    const hasAll = required.every(item => state.inventory.includes(item));
    
    if (!hasAll) {
      const missing = [];
      if (!state.inventory.includes('üó∫Ô∏è')) missing.push(currentLanguage === 'en' ? 'map' : 'mapa');
      if (!state.inventory.includes('‚öì')) missing.push(currentLanguage === 'en' ? 'anchor medallion' : 'medall√≥n de ancla');
      if (!state.inventory.includes('üß≠')) missing.push(currentLanguage === 'en' ? 'compass' : 'br√∫jula');
      if (!state.inventory.includes('üóùÔ∏è')) missing.push(currentLanguage === 'en' ? 'key' : 'llave');
      
      const message = currentLanguage === 'en'
        ? `You need to find all the items before you can dig up the treasure! Still missing: ${missing.join(', ')}`
        : `¬°Necesitas encontrar todos los objetos antes de poder desenterrar el tesoro! A√∫n faltan: ${missing.join(', ')}`;
      showModal(message);
      return;
    }
    
    // Has all items - Open treasure and WIN!
    doorUnlocked = true;
    const winMsg = currentLanguage === 'en'
      ? 'üè¥‚Äç‚ò†Ô∏è You dig up the buried treasure chest and unlock it with the key! Gold, jewels, and ancient artifacts spill out. You\'ve found the legendary pirate treasure and can escape with your fortune!'
      : 'üè¥‚Äç‚ò†Ô∏è ¬°Desentierras el cofre del tesoro y lo abres con la llave! Oro, joyas y artefactos antiguos se derraman. ¬°Has encontrado el legendario tesoro pirata y puedes escapar con tu fortuna!';
    showModal(winMsg);
    setTimeout(() => showScreen('victory'), 2000);
    return;
  }
  
  // Magical Library - Item collection mechanic
  if (currentRoom === 'Magical Library') {
    const required = ['üîÆ', 'üïØÔ∏è', 'üìú'];
    const hasAll = required.every(item => state.inventory.includes(item));
    
    if (!hasAll) {
      const message = currentLanguage === 'en'
        ? 'The bookshelf won\'t budge. You need to gather the magical artifacts: crystal ball, enchanted candle, and mystical scroll.'
        : 'La estanter√≠a no se mueve. Necesitas reunir los artefactos m√°gicos: bola de cristal, vela encantada y pergamino m√≠stico.';
      showModal(message);
      return;
    }
    
    // Has all items - WIN!
    doorUnlocked = true;
    const winMsg = currentLanguage === 'en'
      ? '‚ú® The magical artifacts resonate! The bookshelf slides away, revealing a secret passage bathed in mystical light!'
      : '‚ú® ¬°Los artefactos m√°gicos resuenan! La estanter√≠a se desliza, revelando un pasaje secreto ba√±ado en luz m√≠stica!';
    showModal(winMsg);
    setTimeout(() => showScreen('victory'), 1500);
    return;
  }
  
  // Standard door with code (Mystery Mansion, Haunted Asylum)
  if (!doorUnlocked) {
    if (!state.foundDigits.length) {
      showModal(lang.msgNeedNumbers);
      return;
    }
    openDoorModal();
  } else {
    showModal(lang.msgDoorUnlocked);
    setTimeout(() => showScreen('victory'), 800);
  }
}
  // ========== SETTINGS FUNCTIONS ==========
  function showControls() {
    const lang = translations[currentLanguage];
    showModal(lang.msgControls);
  }

  function showHowToPlay() {
    const lang = translations[currentLanguage];
    showModal(lang.msgHowToPlay);
  }

  // ========== INITIALIZATION ==========
// ========== INITIALIZATION ==========
loadHotspots();
renderRooms();
updateInventory();
updateLanguage();

// Enable audio playback on first user interaction
function enableAudioOnInteraction() {
  if (audioEnabled) {
    playMenuMusic();
  }
  // Remove listeners after first interaction
  document.removeEventListener('click', enableAudioOnInteraction);
  document.removeEventListener('keydown', enableAudioOnInteraction);
}

document.addEventListener('click', enableAudioOnInteraction);
document.addEventListener('keydown', enableAudioOnInteraction);


  // Hotspot editor placeholder functions (keep for compatibility)
  function loadHotspots() {}
  function saveHotspots() {}
  function resetHotspots() {}
  function toggleHotspotEditor() {}
  function selectHotspot() {}
  function nudgeSelected() {}

</script>
</body>
</html>



